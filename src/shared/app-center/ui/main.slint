struct AppItem {
    name: string,
    id: string,
    version: string,
    description: string,
    source: string,
    icon_path: string,
    homepage: string,
    votes: int,
    popularity: float,
    installed: bool,
}

export global Theme {
    in-out property <color> bg: #1e1e2e;
    in-out property <color> fg: #cdd6f4;
    in-out property <color> fg_dim: #a6adc8;
    in-out property <color> accent: #89b4fa;
    in-out property <color> bg_light: #45475a;
    in-out property <color> bg_lighter: #585b70;
    in-out property <color> red: #f38ba8;
    in-out property <color> green: #a6e3a1;
    in-out property <color> yellow: #f9e2af;
    in-out property <color> cyan: #94e2d5;
    in-out property <float> opacity: 0.40;
    in-out property <length> card_radius: 6px;
    in-out property <length> button_radius: 4px;
}

// -- Source badge --
component SourceBadge inherits Rectangle {
    in property <string> label;
    in property <color> badge-color: Theme.accent;

    height: 18px;
    border-radius: 3px;
    background: root.badge-color.transparentize(0.8);
    width: badge-text.preferred-width + 10px;

    badge-text := Text {
        text: root.label;
        color: root.badge-color;
        font-size: 10px;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
}

// -- Pill filter button --
component FilterPill inherits Rectangle {
    in property <string> label;
    in-out property <bool> active: false;
    callback clicked();

    height: 26px;
    border-radius: 13px;
    background: root.active ? Theme.accent : Theme.bg_light;
    width: pill-text.preferred-width + 20px;

    pill-text := Text {
        text: root.label;
        color: root.active ? Theme.bg : Theme.fg;
        font-size: 11px;
        horizontal-alignment: center;
        vertical-alignment: center;
    }

    TouchArea {
        clicked => {
            root.active = !root.active;
            root.clicked();
        }
        mouse-cursor: pointer;
    }
}

// -- Tab button --
component TabButton inherits Rectangle {
    in property <string> label;
    in property <bool> active: false;
    callback clicked();

    height: 28px;
    border-radius: 14px;
    background: root.active ? Theme.accent.transparentize(0.85) :
        (tab-touch.has-hover ? Theme.bg_light : transparent);
    width: tab-label.preferred-width + 20px;

    tab-label := Text {
        text: root.label;
        color: root.active ? Theme.accent : Theme.fg_dim;
        font-size: 11px;
        font-weight: root.active ? 600 : 400;
        horizontal-alignment: center;
        vertical-alignment: center;
    }

    tab-touch := TouchArea {
        clicked => { root.clicked(); }
        mouse-cursor: pointer;
    }
}

// -- Header button (close, help) --
component HeaderButton inherits Rectangle {
    in property <string> label;
    in property <color> bg-color: Theme.bg_light;
    in property <color> hover-color: Theme.accent;
    callback clicked();

    border-radius: Theme.button_radius;
    background: btn-touch.has-hover ? root.hover-color : root.bg-color;
    min-width: 26px;
    height: 26px;

    HorizontalLayout {
        alignment: center;
        padding-left: 8px;
        padding-right: 8px;
        Text {
            text: root.label;
            color: btn-touch.has-hover ? Theme.bg : Theme.fg;
            font-size: 12px;
            vertical-alignment: center;
        }
    }

    btn-touch := TouchArea {
        clicked => { root.clicked(); }
        mouse-cursor: pointer;
    }
}

// -- Action button (install/remove) --
component ActionButton inherits Rectangle {
    in property <string> label;
    in property <color> btn-color: Theme.accent;
    in property <bool> busy: false;
    callback clicked();

    height: 30px;
    border-radius: Theme.button_radius;
    background: root.busy ? Theme.bg_lighter :
        (action-touch.has-hover ? root.btn-color.brighter(0.1) : root.btn-color);
    width: action-label.preferred-width + 24px;

    action-label := Text {
        text: root.busy ? "..." : root.label;
        color: Theme.bg;
        font-size: 12px;
        font-weight: 600;
        horizontal-alignment: center;
        vertical-alignment: center;
    }

    action-touch := TouchArea {
        enabled: !root.busy;
        clicked => { root.clicked(); }
        mouse-cursor: pointer;
    }
}

// -- App card in search results --
component AppCard inherits Rectangle {
    in property <string> name;
    in property <string> source;
    in property <string> version;
    in property <string> description;
    in property <string> icon_path;
    in property <bool> installed;
    in property <bool> selected: false;
    callback clicked();

    height: 72px;
    clip: true;
    border-radius: Theme.card_radius;
    background: root.selected ? Theme.bg_light : (card-touch.has-hover ? Theme.bg_light.transparentize(0.5) : transparent);
    border-width: root.selected ? 1px : 0px;
    border-color: Theme.accent.transparentize(0.5);

    card-touch := TouchArea {
        clicked => { root.clicked(); }
        mouse-cursor: pointer;
    }

    HorizontalLayout {
        padding: 10px;
        spacing: 10px;

        // Icon placeholder
        Rectangle {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: root.source == "AUR" ? Theme.cyan.transparentize(0.8) :
                root.source == "Flatpak" ? Theme.accent.transparentize(0.8) :
                root.source == "AppImage" ? Theme.green.transparentize(0.8) :
                Theme.yellow.transparentize(0.8);
            vertical-stretch: 0;

            Text {
                text: root.icon_path != "" ? root.icon_path :
                    root.source == "AUR" ? "A" : root.source == "Flatpak" ? "F" :
                    root.source == "AppImage" ? "I" : "S";
                color: root.source == "AUR" ? Theme.cyan :
                    root.source == "Flatpak" ? Theme.accent :
                    root.source == "AppImage" ? Theme.green :
                    Theme.yellow;
                font-size: root.icon_path != "" ? 22px : 18px;
                font-weight: 700;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        // Info column
        VerticalLayout {
            spacing: 2px;
            horizontal-stretch: 1;
            alignment: center;

            HorizontalLayout {
                spacing: 6px;
                Text {
                    text: root.name;
                    color: Theme.fg;
                    font-size: 13px;
                    font-weight: 600;
                    overflow: elide;
                    horizontal-stretch: 1;
                }
                if root.version != "": Text {
                    text: root.version;
                    color: Theme.fg_dim;
                    font-size: 10px;
                    vertical-alignment: center;
                }
                SourceBadge {
                    label: root.source;
                    badge-color: root.source == "AUR" ? Theme.cyan :
                        root.source == "Flatpak" ? Theme.accent :
                        root.source == "AppImage" ? Theme.green :
                        Theme.yellow;
                }
                if root.installed: SourceBadge {
                    label: "installed";
                    badge-color: Theme.green;
                }
            }

            Text {
                text: root.description;
                color: Theme.fg_dim;
                font-size: 11px;
                overflow: elide;
            }
        }
    }
}

// -- Main window --
export component MainWindow inherits Window {
    width: 560px;
    height: 620px;
    title: "App Center";
    no-frame: true;
    background: Theme.bg.transparentize(1.0 - Theme.opacity);
    forward-focus: key-scope;

    // -- Properties --
    in-out property <[AppItem]> results: [];
    in-out property <int> selected-index: -1;
    in-out property <string> search-text: "";
    in-out property <string> title-text: "App Center";
    in-out property <string> status-text: "";
    in-out property <string> detail-description: "";
    in-out property <bool> searching: false;
    in-out property <bool> show-detail: false;
    in-out property <bool> show-help: false;
    in-out property <bool> installing: false;
    in-out property <string> install-status: "";
    in-out property <string> console-output: "";
    in-out property <string> console-last-line: "";
    in-out property <bool> process-finished: false;
    in-out property <bool> process-success: false;

    // Tab state
    in-out property <int> current-tab: 0;  // 0 = search, 1 = recommended

    // Filter states
    in-out property <bool> filter-aur: true;
    in-out property <bool> filter-flatpak: true;
    in-out property <bool> filter-appimage: true;

    // -- Callbacks --
    callback search(string);
    callback select-app(int);
    callback install-app(int);
    callback uninstall-app(int);
    callback open-homepage(int);
    callback refresh-catalog();
    callback close();
    callback start-drag();
    callback filter-changed();
    callback send-console-input(string);
    callback cancel-install();
    callback switch-tab(int);

    // -- Public functions --
    public function focus-search() {
        search-input.focus();
    }

    public function focus-list() {
        key-scope.focus();
    }

    public function go-back() {
        root.show-detail = false;
        key-scope.focus();
    }

    // -- Scroll helpers --
    private property <length> row-height: 72px;
    private property <length> row-spacing: 4px;
    private property <length> row-step: root.row-height + root.row-spacing;

    function min-viewport-y() -> length {
        if (list_flick.height >= list_flick.viewport-height) {
            return 0px;
        }
        return list_flick.height - list_flick.viewport-height;
    }

    function clamp-viewport() {
        if (list_flick.viewport-y > 0px) {
            list_flick.viewport-y = 0px;
        }
        if (list_flick.viewport-y < root.min-viewport-y()) {
            list_flick.viewport-y = root.min-viewport-y();
        }
    }

    function ensure-selected-visible() {
        if (root.selected-index < 0 || root.selected-index >= root.results.length) { return; }
        if (list_flick.viewport-y + root.selected-index * root.row-step < 0px) {
            list_flick.viewport-y = 0px - root.selected-index * root.row-step;
        }
        if (list_flick.viewport-y + root.selected-index * root.row-step + root.row-height > list_flick.height) {
            list_flick.viewport-y = list_flick.height - root.selected-index * root.row-step - root.row-height;
        }
        root.clamp-viewport();
    }

    changed selected-index => { root.ensure-selected-visible(); }

    // -- Keyboard handler --
    key-scope := FocusScope {
        key-pressed(event) => {
            // Ctrl+Tab / Ctrl+Shift+Tab: cycle tabs (works everywhere)
            if (event.modifiers.control && event.text == Key.Tab) {
                if (event.modifiers.shift) {
                    // Previous tab
                    root.current-tab = root.current-tab == 0 ? 1 : 0;
                } else {
                    // Next tab
                    root.current-tab = root.current-tab == 1 ? 0 : 1;
                }
                root.show-detail = false;
                root.switch-tab(root.current-tab);
                return accept;
            }

            // Help overlay intercepts
            if (root.show-help) {
                if (event.text == Key.Escape || event.text == "?" || event.text == "/") {
                    root.show-help = false;
                    return accept;
                }
                return reject;
            }

            // Detail view
            if (root.show-detail) {
                // Let Ctrl+C / Ctrl+A pass through to TextInput for copy/select-all
                if (event.modifiers.control && (event.text == "c" || event.text == "a")) {
                    return reject;
                }
                if (event.text == Key.Escape || event.text == "q") {
                    root.go-back();
                    return accept;
                }
                if (event.text == "i") {
                    root.install-app(root.selected-index);
                    return accept;
                }
                if (event.text == "u") {
                    root.uninstall-app(root.selected-index);
                    return accept;
                }
                if (event.text == "o") {
                    root.open-homepage(root.selected-index);
                    return accept;
                }
                return reject;
            }

            // List view
            if (event.text == Key.Escape) {
                if (root.search-text != "") {
                    root.search-text = "";
                    root.search("");
                    return accept;
                }
                root.close();
                return accept;
            }
            if (event.text == "?" || event.text == "/") {
                if (event.text == "?") {
                    root.show-help = true;
                    return accept;
                }
                if (root.current-tab != 0) {
                    root.current-tab = 0;
                    root.show-detail = false;
                    root.switch-tab(0);
                }
                search-input.focus();
                return accept;
            }
            if (event.text == Key.UpArrow || event.text == "k") {
                if (root.selected-index > 0) {
                    root.selected-index -= 1;
                }
                return accept;
            }
            if (event.text == Key.DownArrow || event.text == "j") {
                if (root.selected-index < root.results.length - 1) {
                    root.selected-index += 1;
                }
                return accept;
            }
            if (event.text == Key.Return) {
                if (root.selected-index >= 0) {
                    root.select-app(root.selected-index);
                }
                return accept;
            }
            if (event.text == Key.Home) {
                root.selected-index = 0;
                return accept;
            }
            if (event.text == Key.End) {
                root.selected-index = root.results.length - 1;
                return accept;
            }
            if (event.text == "r") {
                root.refresh-catalog();
                return accept;
            }
            // Type to search - single printable chars jump to search
            return reject;
        }
    }

    // -- Layout --
    VerticalLayout {
        padding: 0px;

        // == Header bar ==
        Rectangle {
            height: 42px;
            background: Theme.bg.darker(0.05);

            // Drag area
            TouchArea {
                moved => { root.start-drag(); }
            }

            HorizontalLayout {
                padding-left: 14px;
                padding-right: 8px;
                alignment: space-between;

                // Title
                HorizontalLayout {
                    alignment: start;
                    spacing: 8px;
                    VerticalLayout {
                        alignment: center;
                        Text {
                            text: root.title-text;
                            color: Theme.fg;
                            font-size: 13px;
                            font-weight: 600;
                        }
                    }
                }

                // Header buttons
                HorizontalLayout {
                    alignment: end;
                    spacing: 4px;
                    VerticalLayout {
                        alignment: center;
                        HeaderButton {
                            label: "?";
                            clicked => { root.show-help = !root.show-help; }
                        }
                    }
                    VerticalLayout {
                        alignment: center;
                        HeaderButton {
                            label: "\u{2715}";
                            bg-color: Theme.bg_light;
                            hover-color: Theme.red;
                            clicked => { root.close(); }
                        }
                    }
                }
            }
        }

        // == Tab bar ==
        Rectangle {
            height: 36px;
            background: transparent;

            HorizontalLayout {
                padding-left: 14px;
                padding-right: 14px;
                padding-top: 4px;
                padding-bottom: 4px;
                spacing: 4px;
                alignment: start;

                TabButton {
                    label: "Search";
                    active: root.current-tab == 0;
                    clicked => {
                        if (root.current-tab != 0) {
                            root.current-tab = 0;
                            root.show-detail = false;
                            root.switch-tab(0);
                        }
                    }
                }

                TabButton {
                    label: "Recommended";
                    active: root.current-tab == 1;
                    clicked => {
                        if (root.current-tab != 1) {
                            root.current-tab = 1;
                            root.show-detail = false;
                            root.switch-tab(1);
                        }
                    }
                }
            }
        }

        // == Search bar (search tab only) ==
        Rectangle {
            height: root.current-tab == 0 ? 44px : 0px;
            clip: true;
            visible: root.current-tab == 0;

            HorizontalLayout {
                padding-left: 14px;
                padding-right: 14px;
                padding-top: 6px;
                padding-bottom: 6px;

                Rectangle {
                    border-radius: Theme.button_radius;
                    background: Theme.bg_light;
                    border-width: search-input.has-focus ? 1px : 0px;
                    border-color: Theme.accent;

                    HorizontalLayout {
                        padding-left: 10px;
                        padding-right: 10px;
                        spacing: 6px;

                        // Search icon
                        VerticalLayout {
                            alignment: center;
                            Text {
                                text: "\u{1F50D}";
                                font-size: 12px;
                                color: Theme.fg_dim;
                            }
                        }

                        search-input := TextInput {
                            vertical-alignment: center;
                            font-size: 13px;
                            color: Theme.fg;
                            text <=> root.search-text;
                            horizontal-stretch: 1;

                            accepted => {
                                root.search(root.search-text);
                                key-scope.focus();
                            }
                        }

                        // Clear button
                        if root.search-text != "": VerticalLayout {
                            alignment: center;
                            Rectangle {
                                width: 18px;
                                height: 18px;
                                border-radius: 9px;
                                background: clear-touch.has-hover ? Theme.bg_lighter : transparent;

                                Text {
                                    text: "\u{2715}";
                                    color: Theme.fg_dim;
                                    font-size: 10px;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }

                                clear-touch := TouchArea {
                                    clicked => {
                                        root.search-text = "";
                                        root.search("");
                                        search-input.focus();
                                    }
                                    mouse-cursor: pointer;
                                }
                            }
                        }
                    }

                    if root.search-text == "": Text {
                        x: 32px;
                        text: "Search apps across AUR, Flatpak, AppImage...";
                        color: Theme.fg;
                        font-size: 13px;
                        vertical-alignment: center;
                        opacity: 0.4;
                    }
                }
            }
        }

        // == Filter pills (search tab only) ==
        Rectangle {
            height: root.current-tab == 0 ? 34px : 0px;
            clip: true;
            visible: root.current-tab == 0;
            background: transparent;

            HorizontalLayout {
                padding-left: 14px;
                padding-right: 14px;
                spacing: 6px;
                alignment: start;

                FilterPill {
                    label: "AUR";
                    active <=> root.filter-aur;
                    clicked => { root.filter-changed(); }
                }
                FilterPill {
                    label: "Flatpak";
                    active <=> root.filter-flatpak;
                    clicked => { root.filter-changed(); }
                }
                FilterPill {
                    label: "AppImage";
                    active <=> root.filter-appimage;
                    clicked => { root.filter-changed(); }
                }

                // Spacer
                Rectangle { horizontal-stretch: 1; }

                // Status
                VerticalLayout {
                    alignment: center;
                    Text {
                        text: root.status-text;
                        color: Theme.fg_dim;
                        font-size: 10px;
                    }
                }
            }
        }

        // == Separator ==
        Rectangle {
            height: 1px;
            background: Theme.bg_light;
        }

        // == Results list or detail view ==
        Rectangle {
            horizontal-stretch: 1;
            vertical-stretch: 1;
            clip: true;

            // -- Searching indicator --
            if !root.show-detail && root.searching: Rectangle {
                vertical-stretch: 1;
                VerticalLayout {
                    alignment: center;
                    Text {
                        text: "Searching...";
                        color: Theme.fg_dim;
                        font-size: 13px;
                        horizontal-alignment: center;
                    }
                }
            }

            // -- No results --
            if !root.show-detail && !root.searching && root.results.length == 0 && root.search-text != "" && root.current-tab == 0: Rectangle {
                vertical-stretch: 1;
                VerticalLayout {
                    alignment: center;
                    spacing: 6px;
                    Text {
                        text: "No results found";
                        color: Theme.fg_dim;
                        font-size: 14px;
                        horizontal-alignment: center;
                    }
                    Text {
                        text: "Try a different search term";
                        color: Theme.fg_dim;
                        font-size: 11px;
                        horizontal-alignment: center;
                        opacity: 0.6;
                    }
                }
            }

            // -- Welcome screen --
            if !root.show-detail && !root.searching && root.results.length == 0 && root.search-text == "" && root.current-tab == 0: Rectangle {
                vertical-stretch: 1;
                VerticalLayout {
                    alignment: center;
                    spacing: 6px;

                    Text {
                        text: "Type a query and press Enter to search";
                        color: Theme.fg;
                        font-size: 13px;
                        horizontal-alignment: center;
                        opacity: 0.7;
                    }
                }
            }

            // -- Results list (always present, visibility-controlled) --
            list_flick := Flickable {
                visible: !root.show-detail && !root.searching && root.results.length > 0;
                vertical-stretch: 1;
                width: parent.width;
                height: parent.height;
                viewport-height: root.results.length * root.row-step;

                VerticalLayout {
                    padding: 6px;
                    spacing: root.row-spacing;

                    for item[idx] in root.results: AppCard {
                        name: item.name;
                        source: item.source;
                        version: item.version;
                        description: item.description;
                        icon_path: item.icon_path;
                        installed: item.installed;
                        selected: idx == root.selected-index;
                        clicked => {
                            root.selected-index = idx;
                            root.select-app(idx);
                        }
                    }
                }
            }

            // -- Detail view --
            if root.show-detail && root.selected-index >= 0 && root.selected-index < root.results.length: Rectangle {
                width: parent.width;
                height: parent.height;

                Flickable {
                    width: parent.width;
                    height: parent.height;
                    VerticalLayout {
                        padding: 20px;
                        spacing: 12px;

                        // Back button
                        HorizontalLayout {
                            alignment: start;
                            HeaderButton {
                                label: "\u{2190} Back";
                                clicked => { root.go-back(); }
                            }
                        }

                        // App header
                        HorizontalLayout {
                            spacing: 14px;

                            // Big icon placeholder
                            Rectangle {
                                width: 64px;
                                height: 64px;
                                border-radius: 12px;
                                background: root.results[root.selected-index].source == "AUR"
                                    ? Theme.cyan.transparentize(0.8) :
                                    root.results[root.selected-index].source == "Flatpak"
                                    ? Theme.accent.transparentize(0.8) :
                                    root.results[root.selected-index].source == "AppImage"
                                    ? Theme.green.transparentize(0.8) :
                                    Theme.yellow.transparentize(0.8);
                                vertical-stretch: 0;

                                Text {
                                    text: root.results[root.selected-index].icon_path != ""
                                        ? root.results[root.selected-index].icon_path :
                                        root.results[root.selected-index].source == "AUR" ? "A" :
                                        root.results[root.selected-index].source == "Flatpak" ? "F" :
                                        root.results[root.selected-index].source == "AppImage" ? "I" : "S";
                                    color: root.results[root.selected-index].source == "AUR"
                                        ? Theme.cyan :
                                        root.results[root.selected-index].source == "Flatpak"
                                        ? Theme.accent :
                                        root.results[root.selected-index].source == "AppImage"
                                        ? Theme.green : Theme.yellow;
                                    font-size: root.results[root.selected-index].icon_path != "" ? 32px : 24px;
                                    font-weight: 700;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }
                            }

                            VerticalLayout {
                                spacing: 4px;
                                horizontal-stretch: 1;
                                alignment: center;

                                Text {
                                    text: root.results[root.selected-index].name;
                                    color: Theme.fg;
                                    font-size: 18px;
                                    font-weight: 600;
                                }

                                HorizontalLayout {
                                    spacing: 8px;
                                    SourceBadge {
                                        label: root.results[root.selected-index].source;
                                        badge-color: root.results[root.selected-index].source == "AUR"
                                            ? Theme.cyan :
                                            root.results[root.selected-index].source == "Flatpak"
                                            ? Theme.accent :
                                            root.results[root.selected-index].source == "AppImage"
                                            ? Theme.green : Theme.yellow;
                                    }
                                    if root.results[root.selected-index].version != "": Text {
                                        text: root.results[root.selected-index].version;
                                        color: Theme.fg_dim;
                                        font-size: 11px;
                                        vertical-alignment: center;
                                    }
                                    if root.results[root.selected-index].installed: SourceBadge {
                                        label: "installed";
                                        badge-color: Theme.green;
                                    }
                                }
                            }
                        }

                        // Action buttons
                        HorizontalLayout {
                            spacing: 8px;
                            alignment: start;

                            if !root.results[root.selected-index].installed: ActionButton {
                                label: "Install";
                                btn-color: Theme.accent;
                                busy: root.installing;
                                clicked => { root.install-app(root.selected-index); }
                            }
                            if root.results[root.selected-index].installed: ActionButton {
                                label: "Remove";
                                btn-color: Theme.red;
                                busy: root.installing;
                                clicked => { root.uninstall-app(root.selected-index); }
                            }
                            if root.results[root.selected-index].homepage != "": ActionButton {
                                label: "Homepage";
                                btn-color: Theme.bg_lighter;
                                clicked => { root.open-homepage(root.selected-index); }
                            }
                        }

                        // Separator
                        Rectangle {
                            height: 1px;
                            background: Theme.bg_light;
                        }

                        // Description
                        Text {
                            text: root.detail-description != "" ?
                                root.detail-description :
                                root.results[root.selected-index].description;
                            color: Theme.fg;
                            font-size: 12px;
                            wrap: word-wrap;
                        }

                        // Metadata
                        if root.results[root.selected-index].votes > 0: HorizontalLayout {
                            spacing: 4px;
                            Text {
                                text: "Votes:";
                                color: Theme.fg_dim;
                                font-size: 11px;
                            }
                            Text {
                                text: root.results[root.selected-index].votes;
                                color: Theme.fg;
                                font-size: 11px;
                            }
                        }

                        // Status area during install
                        if root.installing: Rectangle {
                            height: 80px;
                            border-radius: Theme.card_radius;
                            background: Theme.bg_light;
                            vertical-stretch: 0;

                            VerticalLayout {
                                padding: 12px;
                                spacing: 8px;

                                // Spinner + status text + cancel
                                HorizontalLayout {
                                    spacing: 8px;
                                    alignment: start;

                                    HorizontalLayout {
                                        spacing: 3px;
                                        alignment: center;
                                        width: 20px;

                                        Rectangle {
                                            width: 4px;
                                            height: 4px;
                                            border-radius: 2px;
                                            background: Theme.accent;
                                            opacity: 0.3 + 0.7 * abs(sin(animation-tick() / 5ms * 1deg));
                                        }
                                        Rectangle {
                                            width: 4px;
                                            height: 4px;
                                            border-radius: 2px;
                                            background: Theme.accent;
                                            opacity: 0.3 + 0.7 * abs(sin((animation-tick() / 5ms + 120) * 1deg));
                                        }
                                        Rectangle {
                                            width: 4px;
                                            height: 4px;
                                            border-radius: 2px;
                                            background: Theme.accent;
                                            opacity: 0.3 + 0.7 * abs(sin((animation-tick() / 5ms + 240) * 1deg));
                                        }
                                    }

                                    Text {
                                        text: "Installing...";
                                        color: Theme.accent;
                                        font-size: 12px;
                                        vertical-alignment: center;
                                        horizontal-stretch: 1;
                                    }

                                    // Cancel button
                                    Rectangle {
                                        width: 60px;
                                        height: 22px;
                                        border-radius: 4px;
                                        background: cancel-touch.has-hover ? Theme.red.transparentize(0.6) : Theme.red.transparentize(0.8);

                                        cancel-touch := TouchArea {
                                            clicked => { root.cancel-install(); }
                                        }

                                        Text {
                                            text: "Cancel";
                                            color: Theme.red;
                                            font-size: 10px;
                                            horizontal-alignment: center;
                                            vertical-alignment: center;
                                        }
                                    }
                                }

                                // Live status line (last meaningful output)
                                Text {
                                    text: root.console-last-line;
                                    color: Theme.fg_dim;
                                    font-size: 11px;
                                    font-family: "JetBrainsMono Nerd Font";
                                    overflow: elide;
                                }

                                // Input row for answering prompts
                                Rectangle {
                                    height: 24px;
                                    border-radius: 4px;
                                    background: Theme.bg.darker(0.1);
                                    vertical-stretch: 0;

                                    HorizontalLayout {
                                        padding-left: 8px;
                                        padding-right: 8px;
                                        spacing: 6px;

                                        Text {
                                            text: ">";
                                            color: Theme.accent;
                                            font-size: 11px;
                                            font-family: "JetBrainsMono Nerd Font";
                                            vertical-alignment: center;
                                        }

                                        console-input := TextInput {
                                            color: Theme.fg;
                                            font-size: 11px;
                                            font-family: "JetBrainsMono Nerd Font";
                                            horizontal-stretch: 1;
                                            vertical-alignment: center;
                                            accepted => {
                                                root.send-console-input(self.text);
                                                self.text = "";
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        // Success message
                        if root.process-finished && root.process-success: Rectangle {
                            height: 36px;
                            border-radius: Theme.card_radius;
                            background: Theme.green.transparentize(0.85);
                            vertical-stretch: 0;

                            HorizontalLayout {
                                padding-left: 12px;
                                spacing: 8px;
                                alignment: start;

                                Text {
                                    text: "\u{2713}";
                                    color: Theme.green;
                                    font-size: 14px;
                                    vertical-alignment: center;
                                }
                                Text {
                                    text: "Installed successfully";
                                    color: Theme.green;
                                    font-size: 12px;
                                    vertical-alignment: center;
                                }
                            }
                        }

                        // Error output (only on failure, scrollable via outer Flickable)
                        if root.process-finished && !root.process-success: Rectangle {
                            border-radius: Theme.card_radius;
                            background: Theme.bg_light;
                            vertical-stretch: 0;

                            VerticalLayout {
                                padding: 10px;
                                spacing: 6px;

                                HorizontalLayout {
                                    spacing: 6px;
                                    alignment: start;

                                    Text {
                                        text: "\u{2717} Failed";
                                        color: Theme.red;
                                        font-size: 11px;
                                        font-weight: 600;
                                    }
                                }

                                Text {
                                    text: root.console-output;
                                    color: Theme.fg_dim;
                                    font-size: 11px;
                                    font-family: "JetBrainsMono Nerd Font";
                                    wrap: word-wrap;
                                }
                            }
                        }
                    }
                }
            }
        }

        // == Bottom status bar ==
        Rectangle {
            height: 24px;
            vertical-stretch: 0;
            background: Theme.bg.darker(0.05);

            HorizontalLayout {
                padding-left: 14px;
                padding-right: 14px;
                Text {
                    text: root.show-detail ? "Esc: back  i: install  u: remove  o: homepage  Ctrl+Tab: switch tab" :
                        root.current-tab == 0 ? "/: search  j/k: navigate  Enter: details  Ctrl+Tab: switch tab  ?: help" :
                        "j/k: navigate  Enter: details  /: search  Ctrl+Tab: switch tab  ?: help";
                    color: Theme.fg;
                    font-size: 10px;
                    vertical-alignment: center;
                    opacity: 0.5;
                }
            }
        }
    }

    // == Help overlay ==
    if root.show-help: Rectangle {
        background: Theme.bg.transparentize(0.1);
        border-radius: Theme.card_radius;

        TouchArea {
            clicked => { root.show-help = false; }
        }

        VerticalLayout {
            padding: 30px;
            spacing: 6px;
            alignment: center;

            Text {
                text: "Keyboard Shortcuts";
                color: Theme.fg;
                font-size: 16px;
                font-weight: 600;
                horizontal-alignment: center;
            }

            Rectangle { height: 12px; }

            for entry in [
                { key: "Ctrl+Tab", desc: "Switch tab" },
                { key: "/", desc: "Focus search" },
                { key: "Esc", desc: "Clear search / close" },
                { key: "j / Down", desc: "Next result" },
                { key: "k / Up", desc: "Previous result" },
                { key: "Enter", desc: "View app details" },
                { key: "i", desc: "Install app (detail view)" },
                { key: "u", desc: "Remove app (detail view)" },
                { key: "o", desc: "Open homepage (detail view)" },
                { key: "r", desc: "Refresh catalogs" },
                { key: "?", desc: "Toggle this help" },
            ]: HorizontalLayout {
                padding-left: 60px;
                padding-right: 60px;
                spacing: 12px;

                Rectangle {
                    width: 80px;
                    Text {
                        text: entry.key;
                        color: Theme.accent;
                        font-size: 12px;
                        font-weight: 600;
                        horizontal-alignment: right;
                    }
                }
                Text {
                    text: entry.desc;
                    color: Theme.fg;
                    font-size: 12px;
                    horizontal-stretch: 1;
                }
            }

            Rectangle { height: 16px; }

            Text {
                text: "Press ? or Esc to close";
                color: Theme.fg_dim;
                font-size: 11px;
                horizontal-alignment: center;
                opacity: 0.5;
            }
        }
    }
}
