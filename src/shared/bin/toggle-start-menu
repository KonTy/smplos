#!/bin/bash
# Toggle smplOS Start Menu
# Uses a Hyprland bindn (non-consuming bind) on left click to detect
# clicks outside the start-menu window and dismiss it.

APP_NAME="start-menu"
BIN_PATH="/usr/local/bin/$APP_NAME"
[[ -f "$BIN_PATH" ]] || BIN_PATH="$HOME/Documents/sources/smplos/src/shared/start-menu/target/release/$APP_NAME"

cleanup_bind() {
    hyprctl keyword unbind ", mouse:272" 2>/dev/null
}

if pkill -x "$APP_NAME" 2>/dev/null; then
    cleanup_bind
else
    "$BIN_PATH" &
    disown
    local_pid=$!

    # Add non-consuming bind in background (don't block launch)
    (sleep 0.1; hyprctl keyword bindn ", mouse:272, exec, start-menu-click-check" 2>/dev/null) &
    disown

    # Cleanup bind when start-menu exits (however it exits)
    (while kill -0 $local_pid 2>/dev/null; do sleep 0.2; done
     cleanup_bind
    ) &
    disown
fi
