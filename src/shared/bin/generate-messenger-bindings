#!/bin/bash
# smplOS: Generate Hyprland keybindings for messenger apps.
# Reads messengers.conf, checks which are installed, auto-assigns
# SUPER SHIFT + <letter> from each app's name (skipping taken keys),
# and writes messenger-bindings.conf for Hyprland to source.
#
# Run on login (autostart) and whenever messengers.conf changes.

set -euo pipefail

MESSENGERS_CONF="${XDG_CONFIG_HOME:-$HOME/.config}/smplos/messengers.conf"
BINDINGS_CONF="${XDG_CONFIG_HOME:-$HOME/.config}/hypr/bindings.conf"
OUTPUT_CONF="${XDG_CONFIG_HOME:-$HOME/.config}/hypr/messenger-bindings.conf"

# --- Collect taken SUPER SHIFT keys from main bindings ---
taken_keys=()
if [[ -f "$BINDINGS_CONF" ]]; then
  while IFS= read -r line; do
    # Match: bind* = ... SUPER SHIFT ... , <KEY>, ...
    # Also match SHIFT SUPER (order doesn't matter in Hyprland)
    if [[ "$line" =~ ^bind[a-z]*[[:space:]]*=[[:space:]]*(SUPER[[:space:]]+SHIFT|SHIFT[[:space:]]+SUPER)[[:space:]]*,[[:space:]]*([^,]+) ]]; then
      key="${BASH_REMATCH[2]}"
      key=$(echo "$key" | tr -d '[:space:]' | tr '[:lower:]' '[:upper:]')
      taken_keys+=("$key")
    fi
  done < "$BINDINGS_CONF"
fi

is_key_taken() {
  local k="${1^^}"  # uppercase
  [[ ${#taken_keys[@]} -eq 0 ]] && return 1
  for t in "${taken_keys[@]}"; do
    [[ "$t" == "$k" ]] && return 0
  done
  return 1
}

# --- Check if an app is launchable ---
is_installed() {
  local class="$1" cmd="$2"
  local bin="${cmd%% *}"  # first word of launch command

  # Native app binary
  command -v "$bin" &>/dev/null && return 0

  # Flatpak
  flatpak list --app 2>/dev/null | grep -qi "$class" && return 0

  # Webapp (.desktop with launch-webapp in Exec=)
  for dir in "$HOME/.local/share/applications" "/usr/local/share/applications" "/usr/share/applications"; do
    for f in "$dir"/*.desktop; do
      [[ -f "$f" ]] || continue
      if grep -q "launch-webapp" "$f" 2>/dev/null; then
        local wm_class
        wm_class=$(grep -oP 'StartupWMClass=\K.*' "$f" 2>/dev/null || true)
        [[ "${wm_class,,}" == "${class,,}" ]] && return 0
      fi
    done
  done

  return 1
}

# --- Pick the best letter from a name ---
pick_letter() {
  local name="$1"
  local upper="${name^^}"

  # Try each letter in the name
  for (( i=0; i<${#upper}; i++ )); do
    local ch="${upper:$i:1}"
    [[ "$ch" =~ [A-Z] ]] || continue
    if ! is_key_taken "$ch"; then
      echo "$ch"
      return 0
    fi
  done

  # Fallback: try all letters A-Z
  for ch in {A..Z}; do
    if ! is_key_taken "$ch"; then
      echo "$ch"
      return 0
    fi
  done

  return 1
}

# --- Main: parse messengers.conf, generate bindings ---
if [[ ! -f "$MESSENGERS_CONF" ]]; then
  # No config → empty output (clear any stale bindings)
  echo "# No messengers configured" > "$OUTPUT_CONF"
  exit 0
fi

entries=()
while IFS='|' read -r name class cmd; do
  # Skip comments and blanks
  [[ "$name" =~ ^[[:space:]]*# ]] && continue
  [[ -z "${name// /}" ]] && continue

  name=$(echo "$name" | xargs)    # trim whitespace
  class=$(echo "$class" | xargs)
  cmd=$(echo "$cmd" | xargs)

  # Skip apps that aren't installed
  if ! is_installed "$class" "$cmd"; then
    continue
  fi

  # Auto-assign a key
  letter=$(pick_letter "$name") || continue
  taken_keys+=("$letter")  # mark as used for next iteration

  entries+=("${name}|${class}|${cmd}|${letter}")
done < "$MESSENGERS_CONF"

# --- Write output config ---
{
  echo "# Auto-generated by generate-messenger-bindings -- do not edit"
  echo ""
  echo "# MESSENGERS"
  echo ""

  if [[ ${#entries[@]} -gt 0 ]]; then
    for entry in "${entries[@]}"; do
      IFS='|' read -r name class cmd letter <<< "$entry"
      echo "bindd = SUPER SHIFT, ${letter}, ${name}, exec, toggle-messenger \"${class}\" ${cmd}"
    done

    echo ""
    echo "# Assigned keys:"
    for entry in "${entries[@]}"; do
      IFS='|' read -r name class cmd letter <<< "$entry"
      echo "#   Super+Shift+${letter} → ${name}"
    done
  fi
} > "$OUTPUT_CONF"

# Notify the user of assigned keys (on first run or changes)
if [[ ${#entries[@]} -gt 0 ]]; then
  summary=""
  for entry in "${entries[@]}"; do
    IFS='|' read -r name class cmd letter <<< "$entry"
    summary+="Super+Shift+${letter}  ${name}\n"
  done
  # Only notify if running interactively (not during boot)
  if [[ -n "${WAYLAND_DISPLAY:-}" ]] && command -v notify-send &>/dev/null; then
    notify-send -a "smplOS" "Messenger Shortcuts" "$(printf "$summary")" 2>/dev/null || true
  fi
fi

echo "Generated ${#entries[@]} messenger binding(s) → $OUTPUT_CONF"
