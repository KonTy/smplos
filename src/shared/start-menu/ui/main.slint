// smplOS Start Menu -- category browser + global search

struct AppItem {
    name: string,
    exec: string,
    category: string,
    category_key: string,
    initial: string,
    icon_image: image,
    has_icon: bool,
    is_web_app: bool,
    source: string,
}

struct CategoryItem {
    key: string,
    label: string,
    icon: string,
}

export global Theme {
    in-out property <color> bg: #1e1e2e;
    in-out property <color> fg: #cdd6f4;
    in-out property <color> fg_dim: #a6adc8;
    in-out property <color> accent: #89b4fa;
    in-out property <color> bg_light: #45475a;
    in-out property <color> bg_lighter: #585b70;
    in-out property <color> red: #f38ba8;
    in-out property <color> green: #a6e3a1;
    in-out property <color> yellow: #f9e2af;
    in-out property <color> cyan: #94e2d5;
    in-out property <float> opacity: 0.40;
    in-out property <length> border_radius: 12px;
}

// ── Category button (sidebar) ──

component CategoryButton inherits Rectangle {
    in property <string> label;
    in property <string> icon;
    in property <bool> active: false;
    in property <bool> is_settings: false;
    callback clicked();

    height: 36px;
    border-radius: 6px;
    background: root.active ? Theme.accent.transparentize(0.8) :
        (touch.has-hover ? Theme.bg_light.transparentize(0.3) : transparent);

    touch := TouchArea {
        clicked => { root.clicked(); }
        mouse-cursor: pointer;
    }

    HorizontalLayout {
        padding-left: 8px;
        padding-right: 8px;
        spacing: 6px;

        Text {
            text: root.icon;
            color: root.active ? Theme.accent : Theme.fg_dim;
            font-size: 14px;
            vertical-alignment: center;
            width: 18px;
            horizontal-alignment: center;
        }

        Text {
            text: root.label;
            color: root.active ? Theme.accent : Theme.fg;
            font-size: 13px;
            font-weight: root.active ? 600 : 400;
            vertical-alignment: center;
            horizontal-stretch: 1;
        }
    }
}

// ── Toolbar icon button (bottom bar) ──

component ToolbarButton inherits Rectangle {
    in property <image> icon_image;
    in property <string> tooltip;
    callback clicked();

    min-width: 40px;
    preferred-width: 40px;
    max-width: 40px;
    min-height: 36px;
    preferred-height: 36px;
    max-height: 36px;
    border-radius: 6px;
    background: touch.has-hover ? Theme.bg_light : Theme.bg_light.transparentize(0.82);

    touch := TouchArea {
        clicked => { root.clicked(); }
        mouse-cursor: pointer;
    }

    Image {
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        width: 18px;
        height: 18px;
        source: root.icon_image;
        image-fit: contain;
        opacity: touch.has-hover ? 1.0 : 0.82;
    }
}

// ── Power menu item ──

component PowerMenuItem inherits Rectangle {
    in property <string> label;
    in property <string> icon;
    in property <bool> active: false;
    out property <bool> hovered: touch.has-hover;
    callback clicked();
    callback pointer-moved();

    height: 34px;
    border-radius: 6px;
    background: root.active ? Theme.accent.transparentize(0.8) : transparent;

    touch := TouchArea {
        clicked => { root.clicked(); }
        moved => { root.pointer-moved(); }
        mouse-cursor: pointer;
    }

    HorizontalLayout {
        padding-left: 10px;
        padding-right: 10px;
        spacing: 8px;

        Text {
            text: root.icon;
            color: root.active ? Theme.accent : Theme.fg_dim;
            font-size: 14px;
            vertical-alignment: center;
            width: 20px;
            horizontal-alignment: center;
        }

        Text {
            text: root.label;
            color: Theme.fg;
            font-size: 13px;
            vertical-alignment: center;
            horizontal-stretch: 1;
        }
    }
}

// ── App row (list item) ──

component AppRow inherits Rectangle {
    in property <string> name;
    in property <string> category;
    in property <string> category_key;
    in property <string> initial;
    in property <image> icon_image;
    in property <bool> has_icon: false;
    in property <bool> is_web_app: false;
    in property <string> source: "";
    in property <bool> show_badge: true;
    in property <bool> highlighted: false;
    callback clicked();

    property <color> badge_color:
        root.category_key == "multimedia" ? Theme.red :
        root.category_key == "development" ? Theme.cyan :
        root.category_key == "graphics" ? Theme.green :
        root.category_key == "internet" ? Theme.accent :
        root.category_key == "office" ? Theme.yellow :
        root.category_key == "settings" ? Theme.accent :
        Theme.fg_dim;

    height: 38px;
    border-radius: 6px;
    background: root.highlighted ? Theme.accent.transparentize(0.8) :
        (touch.has-hover ? Theme.bg_light.transparentize(0.3) : transparent);

    touch := TouchArea {
        clicked => { root.clicked(); }
        mouse-cursor: pointer;
    }

    HorizontalLayout {
        padding-left: 8px;
        padding-right: 8px;
        spacing: 8px;

        // App icon or first-letter fallback
        Rectangle {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            background: root.has_icon ? transparent : root.badge_color.transparentize(0.82);

            if root.has_icon: Image {
                source: root.icon_image;
                width: 24px;
                height: 24px;
                x: 1px;
                y: 1px;
                image-fit: contain;
            }

            if !root.has_icon: Text {
                text: root.initial;
                color: root.badge_color;
                font-size: 12px;
                font-weight: 700;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        // App name
        Text {
            text: root.name;
            color: Theme.fg;
            font-size: 13px;
            overflow: elide;
            vertical-alignment: center;
            horizontal-stretch: 1;
        }

        // Web app globe indicator
        if root.is_web_app: Text {
            text: "\u{f0ac3}";
            color: Theme.fg_dim;
            font-size: 11px;
            vertical-alignment: center;
            width: 16px;
        }

        // Source badge (AUR, Flatpak, AppImage, Web App)
        if root.show_badge && root.source != "": Rectangle {
            width: src-text.preferred-width + 10px;
            height: 18px;
            border-radius: 3px;
            background: root.source == "Flatpak" ? Theme.accent.transparentize(0.88) :
                root.source == "AppImage" ? Theme.green.transparentize(0.88) :
                root.source == "Web App" ? Theme.cyan.transparentize(0.88) :
                Theme.fg_dim.transparentize(0.88);

            src-text := Text {
                text: root.source;
                color: root.source == "Flatpak" ? Theme.accent :
                    root.source == "AppImage" ? Theme.green :
                    root.source == "Web App" ? Theme.cyan :
                    Theme.fg_dim;
                font-size: 9px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
    }
}

// ── Main window ──

export component MainWindow inherits Window {
    title: "smplOS";
    width: 520px;
    height: 580px;
    background: transparent;
    no-frame: true;

    // Properties
    in-out property <[AppItem]> apps;
    in-out property <[CategoryItem]> categories;
    in-out property <int> active-category: -1;
    in-out property <int> app-count: 0;
    in-out property <bool> is-searching: false;
    in-out property <string> search-text <=> search-input.text;
    in-out property <int> focus-zone: 0;      // 0=search, 1=categories, 2=apps
    in-out property <int> selected-app: -1;
    in-out property <int> category-count: 0;
    in-out property <string> version: "";
    in-out property <int> power-menu-index: 0;

    // Callbacks
    callback filter-changed();
    callback launch-app(int);
    callback close();
    callback start-drag();
    callback open-webapp-center();
    callback power-action(string);  // "lock", "restart", "shutdown"

    // Power menu state
    in-out property <bool> show-power-menu: false;
    in-out property <bool> power-menu-follow-hover: true;

    // Focus the search bar
    public function focus-search() { root.focus-zone = 0; search-input.focus(); }
    function focus-cat() {
        root.focus-zone = 1;
        if (root.active-category < 0) {
            root.active-category = 0;
            root.filter-changed();
        }
        cat-scope.focus();
    }
    function focus-app() {
        root.focus-zone = 2;
        if (root.selected-app < 0 && root.app-count > 0) {
            root.selected-app = 0;
        }
        app-scope.focus();
    }
    function go-to-settings() {
        root.active-category = root.category-count - 1;
        root.search-text = "";
        root.show-power-menu = false;
        root.filter-changed();
    }
    function toggle-power-menu() {
        root.show-power-menu = !root.show-power-menu;
        if (root.show-power-menu) {
            root.power-menu-index = 0;
            root.power-menu-follow-hover = true;
            root.focus-zone = 3;
        }
    }
    function power-menu-up() {
        root.power-menu-follow-hover = false;
        if (root.power-menu-index > 0) {
            root.power-menu-index -= 1;
        }
    }
    function power-menu-down() {
        root.power-menu-follow-hover = false;
        if (root.power-menu-index < 2) {
            root.power-menu-index += 1;
        }
    }
    function power-menu-activate() {
        if (root.power-menu-index == 0) {
            root.show-power-menu = false;
            root.power-action("lock");
        }
        if (root.power-menu-index == 1) {
            root.show-power-menu = false;
            root.power-action("restart");
        }
        if (root.power-menu-index == 2) {
            root.show-power-menu = false;
            root.power-action("shutdown");
        }
    }

    // Root container
    Rectangle {
        width: root.width;
        height: root.height;
        background: Theme.bg.transparentize(1.0 - Theme.opacity);
        border-radius: Theme.border_radius;
        border-width: 1px;
        border-color: Theme.bg_lighter.transparentize(0.5);
        clip: true;

        // Outer layout: two rows — content (stretch) + toolbar (fixed)
        VerticalLayout {

            // ═══ Row 1: all content (stretches to fill) ═══
            VerticalLayout {
                vertical-stretch: 1;
                padding: 10px;
                padding-bottom: 0;
                spacing: 8px;

                // ── Header: drag area ──
                Rectangle {
                    height: 20px;

                    TouchArea {
                        moved => { root.start-drag(); }
                    }

                    Text {
                        text: "smplOS";
                        color: Theme.fg_dim;
                        font-size: 11px;
                        font-weight: 600;
                        vertical-alignment: center;
                        x: 2px;
                    }

                    Text {
                        text: "MENU";
                        color: Theme.accent;
                        font-size: 10px;
                        font-weight: 700;
                        vertical-alignment: center;
                        x: 50px;
                    }

                    // Version label (right-aligned)
                    Text {
                        text: root.version;
                        color: Theme.fg_dim.transparentize(0.5);
                        font-size: 9px;
                        vertical-alignment: center;
                        horizontal-alignment: right;
                        x: parent.width - self.preferred-width - 4px;
                    }
                }

            // ── Search bar ──
            search-scope := FocusScope {
                height: 36px;

                key-pressed(event) => {
                    if (root.show-power-menu) {
                        if (event.text == Key.Escape) {
                            root.show-power-menu = false;
                            return accept;
                        }
                        if (event.text == Key.UpArrow) {
                            root.power-menu-up();
                            return accept;
                        }
                        if (event.text == Key.DownArrow) {
                            root.power-menu-down();
                            return accept;
                        }
                        if (event.text == Key.Return) {
                            root.power-menu-activate();
                            return accept;
                        }
                        return accept;
                    }
                    if (event.text == Key.Escape) {
                        root.close();
                        return accept;
                    }
                    if (event.text == Key.Tab && event.modifiers.shift) {
                        root.focus-app();
                        return accept;
                    }
                    if (event.text == Key.Tab) {
                        root.focus-cat();
                        return accept;
                    }
                    if (event.text == Key.DownArrow) {
                        root.focus-cat();
                        return accept;
                    }
                    if (event.modifiers.control && event.text == "p") {
                        root.toggle-power-menu();
                        return accept;
                    }
                    if (event.modifiers.control && event.text == "s") {
                        root.go-to-settings();
                        return accept;
                    }
                    if (event.modifiers.control && event.text == "w") {
                        root.open-webapp-center();
                        return accept;
                    }
                    return reject;
                }

                Rectangle {
                    width: 100%;
                    height: 100%;
                    border-radius: 8px;
                    background: Theme.bg_light;

                    search-input := TextInput {
                        x: 12px;
                        y: (parent.height - self.preferred-height) / 2;
                        width: parent.width - 24px;
                        color: Theme.fg;
                        font-size: 13px;

                        edited => { root.focus-zone = 0; root.filter-changed(); }
                        accepted => {
                            if root.app-count > 0 {
                                root.launch-app(0);
                            }
                        }
                    }

                    // Placeholder
                    if search-input.text == "": Text {
                        x: 12px;
                        y: (parent.height - self.preferred-height) / 2;
                        text: "Search all apps...";
                        color: Theme.fg_dim.transparentize(0.3);
                        font-size: 13px;
                    }
                }
            }

            // ── Content: sidebar + app list (absolute positioning for independent stretch) ──
            Rectangle {
                vertical-stretch: 1;

                // Category sidebar — pinned left, full height
                Rectangle {
                    x: 0;
                    y: 0;
                    width: 120px;
                    height: 100%;
                    border-radius: 8px;
                    background: Theme.bg_light.transparentize(0.7);
                    border-width: root.focus-zone == 1 ? 1px : 0px;
                    border-color: Theme.accent.transparentize(0.5);

                    cat-scope := FocusScope {
                        width: 100%;
                        height: 100%;

                        key-pressed(event) => {
                            if (root.show-power-menu) {
                                if (event.text == Key.Escape) {
                                    root.show-power-menu = false;
                                    return accept;
                                }
                                if (event.text == Key.UpArrow) {
                                    root.power-menu-up();
                                    return accept;
                                }
                                if (event.text == Key.DownArrow) {
                                    root.power-menu-down();
                                    return accept;
                                }
                                if (event.text == Key.Return) {
                                    root.power-menu-activate();
                                    return accept;
                                }
                                return accept;
                            }
                            if (event.text == Key.Escape) {
                                root.focus-search();
                                return accept;
                            }
                            if (event.text == Key.UpArrow) {
                                if (root.active-category > 0) {
                                    root.active-category -= 1;
                                    root.filter-changed();
                                }
                                return accept;
                            }
                            if (event.text == Key.DownArrow) {
                                if (root.active-category < root.category-count - 1) {
                                    root.active-category += 1;
                                    root.filter-changed();
                                }
                                return accept;
                            }
                            if (event.text == Key.Tab && event.modifiers.shift) {
                                root.focus-search();
                                return accept;
                            }
                            if (event.text == Key.Return || event.text == Key.Tab) {
                                root.focus-app();
                                return accept;
                            }
                            if (event.modifiers.control && (event.text == "f" || event.text == "e")) {
                                root.focus-search();
                                return accept;
                            }
                            if (event.modifiers.control && event.text == "p") {
                                root.toggle-power-menu();
                                return accept;
                            }
                            if (event.modifiers.control && event.text == "s") {
                                root.go-to-settings();
                                return accept;
                            }
                            if (event.modifiers.control && event.text == "w") {
                                root.open-webapp-center();
                                return accept;
                            }
                            return reject;
                        }

                        VerticalLayout {
                            padding: 4px;
                            spacing: 1px;
                            alignment: start;

                            for cat[i] in root.categories: VerticalLayout {
                                // Divider before Settings
                                if cat.key == "settings": Rectangle {
                                    height: 1px;
                                    background: Theme.bg_lighter.transparentize(0.5);
                                }

                                CategoryButton {
                                    label: cat.label;
                                    icon: cat.icon;
                                    active: root.active-category == i && (!root.is-searching || root.focus-zone == 1);

                                    clicked => {
                                        root.active-category = i;
                                        root.search-text = "";
                                        root.filter-changed();
                                    }
                                }
                            }

                            // Fill remaining space
                            Rectangle { vertical-stretch: 1; }
                        }
                    }
                }

                // App list — right of sidebar, full height
                Rectangle {
                    x: 126px;
                    y: 0;
                    width: parent.width - 126px;
                    height: 100%;
                    border-radius: 8px;
                    clip: true;
                    border-width: root.focus-zone == 2 ? 1px : 0px;
                    border-color: Theme.accent.transparentize(0.5);

                    app-scope := FocusScope {
                        width: 100%;
                        height: 100%;

                        key-pressed(event) => {
                            if (root.show-power-menu) {
                                if (event.text == Key.Escape) {
                                    root.show-power-menu = false;
                                    return accept;
                                }
                                if (event.text == Key.UpArrow) {
                                    root.power-menu-up();
                                    return accept;
                                }
                                if (event.text == Key.DownArrow) {
                                    root.power-menu-down();
                                    return accept;
                                }
                                if (event.text == Key.Return) {
                                    root.power-menu-activate();
                                    return accept;
                                }
                                return accept;
                            }
                            if (event.text == Key.Escape) {
                                root.focus-search();
                                return accept;
                            }
                            if (event.text == Key.UpArrow) {
                                if (root.selected-app > 0) {
                                    root.selected-app -= 1;
                                    if (root.selected-app * 38px < -app-flick.viewport-y) {
                                        app-flick.viewport-y = -(root.selected-app * 38px);
                                    }
                                }
                                return accept;
                            }
                            if (event.text == Key.DownArrow) {
                                if (root.selected-app < root.app-count - 1) {
                                    root.selected-app += 1;
                                    if ((root.selected-app + 1) * 38px > -app-flick.viewport-y + app-flick.height) {
                                        app-flick.viewport-y = -((root.selected-app + 1) * 38px - app-flick.height);
                                    }
                                }
                                return accept;
                            }
                            if (event.text == Key.Return) {
                                if (root.selected-app >= 0 && root.selected-app < root.app-count) {
                                    root.launch-app(root.selected-app);
                                }
                                return accept;
                            }
                            if (event.text == Key.Tab && event.modifiers.shift) {
                                root.focus-cat();
                                return accept;
                            }
                            if (event.text == Key.Tab) {
                                root.focus-search();
                                return accept;
                            }
                            if (event.modifiers.control && (event.text == "f" || event.text == "e")) {
                                root.focus-search();
                                return accept;
                            }
                            if (event.modifiers.control && event.text == "p") {
                                root.toggle-power-menu();
                                return accept;
                            }
                            if (event.modifiers.control && event.text == "s") {
                                root.go-to-settings();
                                return accept;
                            }
                            if (event.modifiers.control && event.text == "w") {
                                root.open-webapp-center();
                                return accept;
                            }
                            return reject;
                        }

                        app-flick := Flickable {
                            viewport-height: root.app-count * 38px + 10px;

                            VerticalLayout {
                                padding-top: 5px;
                                padding-bottom: 5px;
                                spacing: 0px;

                                for app[i] in root.apps: AppRow {
                                    name: app.name;
                                    category: app.category;
                                    category_key: app.category_key;
                                    initial: app.initial;
                                    icon_image: app.icon_image;
                                    has_icon: app.has_icon;
                                    is_web_app: app.is_web_app;
                                    source: app.source;
                                    show_badge: true;
                                    highlighted: root.focus-zone == 2 && root.selected-app == i;

                                    clicked => { root.launch-app(i); }
                                }
                            }
                        }

                        // Empty state
                        if root.app-count == 0: VerticalLayout {
                            alignment: center;
                            spacing: 6px;
                            padding-left: 16px;
                            padding-right: 16px;

                            Text {
                                text: root.is-searching ? "No apps found" :
                                    "Search or pick a category";
                                color: Theme.fg_dim;
                                font-size: 12px;
                                horizontal-alignment: center;
                            }
                        }
                    }
                }
            }

            }

            // ═══ Row 2: bottom toolbar (fixed height) ═══
            Rectangle {
                height: 40px;
                vertical-stretch: 0;

                // Top divider line
                Rectangle {
                    y: 0;
                    height: 1px;
                    width: 100%;
                    background: Theme.bg_lighter.transparentize(0.5);
                }

                HorizontalLayout {
                    alignment: stretch;
                    spacing: 2px;
                    padding-right: 10px;
                    padding-top: 4px;

                    Rectangle { horizontal-stretch: 1; }

                    ToolbarButton {
                        icon_image: @image-url("assets/icon-web.svg");
                        tooltip: "Web Apps";
                        clicked => { root.open-webapp-center(); }
                    }

                    ToolbarButton {
                        icon_image: @image-url("assets/icon-settings.svg");
                        tooltip: "Settings";
                        clicked => { root.go-to-settings(); }
                    }

                    ToolbarButton {
                        icon_image: @image-url("assets/icon-power.svg");
                        tooltip: "Power";
                        clicked => { root.toggle-power-menu(); }
                    }
                }
            }

        }  // end outer VerticalLayout

        // ── Power popup overlay ──
        if root.show-power-menu: power-menu-scope := FocusScope {
            width: root.width;
            height: root.height;
            property <int> visual-power-index:
                root.power-menu-follow-hover && lock-item.hovered ? 0 :
                root.power-menu-follow-hover && restart-item.hovered ? 1 :
                root.power-menu-follow-hover && shutdown-item.hovered ? 2 :
                root.power-menu-index;

            init => {
                power-menu-scope.focus();
            }

            key-pressed(event) => {
                if (event.text == Key.Escape) {
                    root.show-power-menu = false;
                    root.focus-search();
                    return accept;
                }
                if (event.text == Key.UpArrow) {
                    root.power-menu-up();
                    return accept;
                }
                if (event.text == Key.DownArrow) {
                    root.power-menu-down();
                    return accept;
                }
                if (event.text == Key.Return) {
                    if (lock-item.hovered) {
                        root.power-menu-index = 0;
                    }
                    if (restart-item.hovered) {
                        root.power-menu-index = 1;
                    }
                    if (shutdown-item.hovered) {
                        root.power-menu-index = 2;
                    }
                    root.power-menu-activate();
                    return accept;
                }
                return accept;
            }

            // Click-away backdrop
            TouchArea {
                clicked => { root.show-power-menu = false; root.focus-search(); }
            }

            // Popup card
            Rectangle {
                x: root.width - self.width - 14px;
                y: root.height - self.height - 50px;
                width: 160px;
                height: 112px;
                border-radius: 8px;
                background: Theme.bg.transparentize(0.05);
                border-width: 1px;
                border-color: Theme.bg_lighter.transparentize(0.5);
                clip: true;

                VerticalLayout {
                    padding: 4px;
                    spacing: 2px;

                    lock-item := PowerMenuItem {
                        icon: "\u{f033e}";  // 󰌾 lock
                        label: "Lock";
                        active: power-menu-scope.visual-power-index == 0;
                        pointer-moved => { root.power-menu-follow-hover = true; root.power-menu-index = 0; }
                        clicked => { root.show-power-menu = false; root.power-action("lock"); }
                    }

                    restart-item := PowerMenuItem {
                        icon: "\u{f0709}";  // 󰜉 restart
                        label: "Restart";
                        active: power-menu-scope.visual-power-index == 1;
                        pointer-moved => { root.power-menu-follow-hover = true; root.power-menu-index = 1; }
                        clicked => { root.show-power-menu = false; root.power-action("restart"); }
                    }

                    shutdown-item := PowerMenuItem {
                        icon: "\u{f0425}";  // 󰐥 power off
                        label: "Shut Down";
                        active: power-menu-scope.visual-power-index == 2;
                        pointer-moved => { root.power-menu-follow-hover = true; root.power-menu-index = 2; }
                        clicked => { root.show-power-menu = false; root.power-action("shutdown"); }
                    }
                }
            }
        }
    }
}

